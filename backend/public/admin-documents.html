<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Argus – Admin Documents</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        margin: 0;
        padding: 0;
        background: #f3f4f6;
      }
      .navbar {
        background: #111827;
        color: #fff;
        padding: 0.75rem 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: center;
      }
      .navbar a {
        color: #e5e7eb;
        text-decoration: none;
        font-size: 0.9rem;
      }
      .navbar a.active {
        color: #ffffff;
        font-weight: 600;
      }
      .container {
        max-width: 960px;
        margin: 2rem auto;
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .admin-subnav {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .admin-subnav a {
        font-size: 0.9rem;
        color: #2563eb;
        text-decoration: none;
        padding: 0.25rem 0.6rem;
        border-radius: 0.25rem;
        background: #eff6ff;
      }
      .admin-subnav a.active {
        background: #dbeafe;
        font-weight: 600;
      }
      h1 {
        margin-top: 0;
        font-size: 1.5rem;
        color: #111827;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
      }
      th {
        background: #f9fafb;
        text-align: left;
      }
      button {
        padding: 0.25rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d5db;
        background: #f3f4f6;
        cursor: pointer;
      }
      button:hover {
        background: #e5e7eb;
      }
      .status {
        margin-top: 1rem;
        font-size: 0.85rem;
        color: #374151;
        white-space: pre-wrap;
      }
      .filter-row {
        margin-top: 0.75rem;
        margin-bottom: 0.75rem;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .filter-row input[type='text'] {
        flex: 1;
        padding: 0.3rem 0.45rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <a href="/login.html">Login</a>
      <a href="/register.html">Register</a>
      <a href="/documents.html">Documents</a>
      <a href="/search.html">Search</a>
      <a href="/openai-documents.html">OpenAI</a>
      <a href="/admin-modules.html" class="active">Admin</a>
      <a href="#" id="logout-link">Logout</a>
    </div>
    <div class="container">
      <h1>Admin – Documents</h1>
      <div class="admin-subnav">
        <a href="/admin-modules.html">Modules</a>
        <a href="/admin-taxonomy.html">Taxonomies</a>
        <a href="/admin-documents.html" class="active">Documents</a>
      </div>
      <p>
        Inspect documents and jump to per-document module and taxonomy tools.
        Use the file name filter to quickly locate a specific document.
      </p>

      <div class="filter-row">
        <label for="filename_filter">File name filter:</label>
        <input
          id="filename_filter"
          type="text"
          placeholder="Type to filter by file name (case-insensitive)..."
        />
      </div>

      <table id="docs-table">
        <thead>
          <tr>
            <th>File Name</th>
            <th>Document Type</th>
            <th>Date</th>
            <th>Provider</th>
            <th>Modules</th>
            <th>Taxonomies</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="status" id="status"></div>
    </div>

    <script src="/auth.js"></script>
    <script>
      const statusEl = document.getElementById('status');
      const tableBody = document.querySelector('#docs-table tbody');
      const filenameFilterInput = document.getElementById('filename_filter');

      let allDocs = [];

      async function loadDocuments() {
        statusEl.textContent = 'Loading documents...';
        tableBody.innerHTML = '';
        try {
          const res = await fetch('/api/documents/db', {
            credentials: 'include',
          });
          const json = await res.json();
          if (!res.ok) {
            statusEl.textContent =
              'Failed to load documents: ' + (json.error || res.status);
            return;
          }
          const rawItems = Array.isArray(json.items) ? json.items : [];
          // Normalize items into a flat shape for easier rendering.
          allDocs = rawItems.map((item) => {
            const attrs = item && item.attributes ? item.attributes : {};
            return {
              id: item.id,
              filename: attrs.file_name || '',
              documentType: attrs.document_type || '',
              date: attrs.date || '',
              providerName: attrs.provider_name || '',
            };
          });
          statusEl.textContent = `Loaded ${allDocs.length} document(s).`;
          renderDocuments();
        } catch (err) {
          statusEl.textContent =
            'Error loading documents: ' + (err && err.message ? err.message : err);
        }
      }

      function renderDocuments() {
        const filter = filenameFilterInput.value.trim().toLowerCase();
        tableBody.innerHTML = '';

        const filtered = allDocs.filter((doc) => {
          if (!filter) return true;
          const name = (doc.filename || '').toLowerCase();
          return name.includes(filter);
        });

        for (const doc of filtered) {
          const tr = document.createElement('tr');

          const fileTd = document.createElement('td');
          fileTd.textContent = doc.filename || '';
          tr.appendChild(fileTd);

          const typeTd = document.createElement('td');
          typeTd.textContent = doc.documentType || '';
          tr.appendChild(typeTd);

          const dateTd = document.createElement('td');
          dateTd.textContent = doc.date || '';
          tr.appendChild(dateTd);

          const providerTd = document.createElement('td');
          providerTd.textContent = doc.providerName || '';
          tr.appendChild(providerTd);

          const modulesTd = document.createElement('td');
          const modulesBtn = document.createElement('button');
          modulesBtn.textContent = 'Modules...';
          modulesBtn.addEventListener('click', () => {
            window.location.href =
              '/admin-document-modules.html?id=' + encodeURIComponent(doc.id);
          });
          modulesTd.appendChild(modulesBtn);
          tr.appendChild(modulesTd);

          const taxTd = document.createElement('td');
          const taxBtn = document.createElement('button');
          taxBtn.textContent = 'Taxonomies...';
          taxBtn.addEventListener('click', () => {
            window.location.href =
              '/admin-document-taxonomy.html?id=' + encodeURIComponent(doc.id);
          });
          taxTd.appendChild(taxBtn);
          tr.appendChild(taxTd);

          tableBody.appendChild(tr);
        }
      }

      filenameFilterInput.addEventListener('input', () => {
        renderDocuments();
      });

      void loadDocuments();
    </script>
  </body>
  </html>
