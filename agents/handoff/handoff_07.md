# Handoff_07 – Argus Document Intelligence

## Thread context

- Seventh agent thread for the Argus project.
- Picked up after Handoff_06 with focus on Admin tools, taxonomies, and search UI.
- This thread begins with environment/context sync only; concrete tasks will be added here as they are undertaken.

## High-level system state (snapshot)

- Backend: Node.js + TypeScript + Express in `backend/`.
- Frontend: HTML-based admin and search pages in `backend/public/`.
- Search: DB-backed search over `documents.markdown` with metadata and taxonomy filtering; vector search currently disabled in UI.
- Admin: Modules, Taxonomies, and Documents tools wired to backend endpoints for rebuilds and inspection.

## Active work in this thread

- Initial setup: reread `agents/README.md` and latest handoff (`handoff_06.md`), then created this `handoff_07.md` file.
- Commit `docs(readme): document per-document admin iteration` – documented per-document module + taxonomy iteration flow in root `README.md` for tightening/refining module taxonomies on a single file via Admin Documents → Modules... / Taxonomies.... Keywords: #docs #admin #taxonomy.
- Commit `Subject: docs(config): clarify agent git instructions` – updated `agents/git.md` to move the type/scope subject line under a labeled `Subject:` block only, and adjusted the example command so agents no longer generate duplicate subject lines in commits. Keywords: #docs #git #agents.
- Updated `backend/public/search.html` UX for text search rows so that term inputs are stacked vertically, the “+ term” button appears below the stack within each row, the old “× row” label is replaced by a simple “×” control, and each row is visually grouped with a green outline to emphasize the (rows = AND, terms = OR) grouping. The row container is set to 40% width and term inputs now expand to 100% of that container with `box-sizing: border-box` so the fields stay fully inside the green outline.
- Adjusted the text search row “×” control behavior so it now removes only the last term input in that row (and clears the value when only a single term input remains), rather than deleting the entire row.
- Added a green row-delete “×” button that appears next to the first term in each row (hidden for the first row, shown for subsequent rows) and removes the entire row while guaranteeing at least one row remains; blue “×” buttons are now attached to individual term rows (all except the first term in each row) and remove only their adjacent term.
- Began implementing Mental Health taxonomy normalization by seeding canonical keywords `mental_health.medication_for_mental_health` and `mental_health.presentation` in `backend/src/db.ts` with rich synonyms covering antidepressant/psychiatric medications and behavior/presentation phrases (emotionally labile, pressured speech, combative, etc.).
- Updated `backend/src/routes/search.ts` so `/api/search/options` filters out legacy granular Mental Health keywords (`mental_health.antidepressant_medication`, `.antidepressant_medication_use`, `.emotionally_labile`, `.pressured_speech`, `.combative_or_hostile`, `.emotionally_distressed`, `.non_compliant`) from the keyword facet dropdown, leaving only the canonical Mental Health keywords visible going forward.
- Added `backend/sql/migrate_mental_health_taxonomy.sql` as a one-time SQL migration that:
  - Inserts canonical `mental_health.medication_for_mental_health` rows into `document_terms` for any document currently tagged with `mental_health.antidepressant_medication` or `.antidepressant_medication_use`, rewires related evidence, and deletes the legacy med keywords from `document_terms`.
  - Inserts canonical `mental_health.presentation` rows for any document tagged with behavior-related MH keywords (`.emotionally_labile`, `.pressured_speech`, `.combative_or_hostile`, `.emotionally_distressed`, `.non_compliant`), rewires evidence, and deletes those legacy keyword ids from `document_terms`.
- Extended `updateTaxonomyFromProjections` (Mental Health section) in `backend/src/metadataProjections.ts` to emit a single projection-backed `mental_health.presentation` keyword when any of the behavior/affect flags (affect_labile, behavior_emotionally_distressed, behavior_non_compliant, behavior_guarded_or_hostile, pressured_speech) are set in `document_mental_health`, with rule-based evidence summarizing which flags were present; existing any_mention/anxiety/depression/SUD keywords are preserved.
- Updated the LLM taxonomy extraction prompt in `runTaxonomyExtractionForDocument` (`backend/src/routes/documents.ts`) so that when `category.id === 'mental_health'`, the model is explicitly instructed to map medication mentions to `mental_health.medication_for_mental_health`, map observed presentation/behavior (emotionally labile, pressured speech, combative/hostile, guarded, emotionally distressed, non-compliant, etc.) to `mental_health.presentation`, and avoid inventing new `mental_health.*` keywords for concepts that belong under these canonical keywords (using subkeywords instead when additional detail is needed).
- Implemented a minimal projection pipeline for Appointments: added `upsertDocumentAppointments` in `backend/src/metadataProjections.ts` that derives appointment rows in `document_appointments` from universal metadata (follow_up_recommended, follow_up_timeframe, risk_flags.missed_follow_up/urgent_recommendation, document_quality_flags.explicit_follow_up_plan) and wired it into `updateDocumentProjectionsForVectorStoreFile`, so Admin Taxonomy → Rebuild for `appointments` now repopulates an `appointments.any_mention` keyword based on structured follow-up/appointment signals rather than relying solely on LLM taxonomy.
- Updated `updateTaxonomyFromProjections` cleanup to only delete `document_term_evidence` rows with `evidence_type='rule'` for projection-backed categories (including appointments), so LLM-driven `evidenceType='snippet'` records are preserved across projection rebuilds; this prevents appointments (and other categories) from losing their snippet evidence after ingestion or taxonomy rebuilds.
- Added `backend/sql/migrate_appointments_taxonomy.sql` to normalize Appointments taxonomy: it converts over-specified keyword ids of the form `appointments.<parent>.<child>` (e.g., `appointments.diagnostic_imaging_appointment.chest_x_ray_imaging`) into subkeywords under their parent keyword (`appointments.diagnostic_imaging_appointment`), updates `document_terms` and `document_term_evidence` so evidence follows, and deletes the migrated keyword rows. This keeps the Keyword dropdown focused (e.g., “Diagnostic Imaging Appointment”, “Referral Appointment”) while exposing the more specific variations under the Subkeyword dropdown, and is a pattern we can reuse when cleaning up other categories with similar “keyword-as-subkeyword” drift.
- Added `backend/sql/migrate_communication_taxonomy.sql` to apply the same normalization pattern to the Communication category: any `communication.<parent>.<child>` ids (where `<parent>` is an existing Communication keyword such as `communication.patient_initiated`) are migrated into `taxonomy_subkeywords` under that parent, and `document_terms` / `document_term_evidence` are rewritten accordingly. This cleans up noisy Communication keyword facets (keeping high-level keywords like “Any communication mention”, “Patient-initiated communication”, “Provider-initiated communication” in the Keyword dropdown) while surfacing finer-grained distinctions in the Subkeyword dropdown, and provides a reusable template for future taxonomy cleanups.
- Added `backend/sql/migrate_results_taxonomy.sql` to normalize the Results category in the same way: any `results.<parent>.<child>` ids (where `<parent>` is an existing Results keyword such as `results.lab` or `results.imaging`) are converted into subkeywords under that parent, with `document_terms` and `document_term_evidence` updated so snippet evidence follows. This keeps the Results keyword facet limited to high-level concepts (Any results, Lab, Imaging) and moves specific panels/studies into Subkeywords, aligning Results with the cleaned-up Appointments and Communication taxonomies.
- Tweaked text search row controls in `backend/public/search.html` so per-term and per-row `[x]` cancel buttons are solid red (shared styling for both blue and green variants), `+ term` buttons render in black within each text row, and the `+ Add row` control is a solid medium green, making the different text-search actions visually distinct while preserving existing behavior.
- Enhanced `/api/search/options` and `/search.html` so the backend reports which `document_type` values actually have associated documents, and the frontend styles any `document_type` option with no documents in medium gray while leaving all types selectable. Similarly, taxonomy keyword and subkeyword options now carry a `docCount` field and the Encounters → Keyword/Subkeyword dropdowns render entries with zero associated documents in medium gray. This keeps the full vocabularies visible while visually hinting which document types, keywords, and subkeywords are currently represented in the corpus.

## Notes for next agent

- Before making changes, confirm the current user request and classify Interaction Mode (Discussion / Architecture / Implementation Plan / Execution).
- If entering Execution Mode, ensure there is an explicit implementation plan (either existing or newly created) and keep this handoff updated as meaningful milestones are reached.
